import React, { useState, useEffect, useRef } from 'react';
import {
X, Mic, PhoneOff, Sparkles, Check, ChevronRight, Headphones, Settings,
Globe, MessageSquare, Palette, Upload, Building2, Link as LinkIcon,
Moon, Sun, Star, Activity, AlignLeft, AlignCenter, AlignRight, MoveHorizontal, MoveVertical
} from 'lucide-react';

/**
* VOICE CONCIERGE WIDGET v6.2 (Center Close Button Position Fix)
* * Изменения:
* - Кнопка закрытия (крестик) в режиме Center перенесена с диагонали (-top-5 -right-5) на боковую грань.
* - Новая позиция: По вертикали центр (top-1/2), по горизонтали справа (-right-12).
*/

// --- Конфигурация Стилей (Themes) ---

const THEME_MODES = {
dark: {
id: 'dark',
bg: 'bg-slate-900',
text: 'text-white',
subtext: 'text-slate-400',
border: 'border-white/10',
inputBg: 'bg-white/5',
buttonBg: 'bg-white/10 hover:bg-white/20',
shadow: 'shadow-2xl',
activeBorderBase: 'ring-2 ring-offset-2 ring-offset-slate-900',
},
light: {
id: 'light',
bg: 'bg-white',
text: 'text-slate-900',
subtext: 'text-slate-500',
border: 'border-slate-200',
inputBg: 'bg-slate-50',
buttonBg: 'bg-slate-100 hover:bg-slate-200',
shadow: 'shadow-xl',
activeBorderBase: 'ring-2 ring-offset-2 ring-offset-white',
}
};

const TEXT_VARIATIONS = {
ru: {
label: "Русский",
variants: [
{
id: 'formal',
name: 'Официальный',
greeting: '',
button: 'Начать разговор',
connecting: 'Подключение...',
listening: '',
end: 'Закончить',
title: 'Консьерж',
tooltip: 'Привет! Я Феликс :) Чем могу помочь?'
},
]
},
en: {
label: "English",
variants: [
{
id: 'formal',
name: 'Formal',
greeting: '',
button: 'Start Conversation',
connecting: 'Connecting...',
listening: '',
end: 'End Call',
title: 'Concierge',
tooltip: 'Hi! I am Felix :) How can I help you?'
},
]
}
};

const COLOR_THEMES = [
{ id: 'gold', name: 'Gold Luxury', primary: 'from-amber-400 to-yellow-600', glow: 'bg-amber-400', text:
'text-amber-600', accent: 'bg-amber-400', ring: 'ring-amber-400', rgb: '251, 191, 36' },
{ id: 'blue', name: 'Deep Ocean', primary: 'from-blue-500 to-indigo-600', glow: 'bg-blue-400', text: 'text-blue-600',
accent: 'bg-blue-400', ring: 'ring-blue-400', rgb: '96, 165, 250' },
{ id: 'emerald', name: 'Nature Green', primary: 'from-emerald-400 to-teal-600', glow: 'bg-emerald-400', text:
'text-emerald-600', accent: 'bg-emerald-400', ring: 'ring-emerald-400', rgb: '52, 211, 153' },
{ id: 'purple', name: 'Royal Velvet', primary: 'from-purple-500 to-fuchsia-600', glow: 'bg-fuchsia-400', text:
'text-purple-600', accent: 'bg-fuchsia-400', ring: 'ring-fuchsia-400', rgb: '232, 121, 249' },
{ id: 'red', name: 'Imperial Red', primary: 'from-red-500 to-rose-600', glow: 'bg-red-500', text: 'text-red-600',
accent: 'bg-red-500', ring: 'ring-red-500', rgb: '239, 68, 68' },
];

// --- Компонент: Админ Панель ---
const AdminPanel = ({ config, setConfig, isOpen, setIsOpen }) => {
const fileInputRef = useRef(null);

const handleLogoUpload = (e) => {
const file = e.target.files[0];
if (file) {
const reader = new FileReader();
reader.onloadend = () => {
setConfig({ ...config, hotelLogo: reader.result });
};
reader.readAsDataURL(file);
}
};

if (!isOpen) {
return (
<button onClick={()=> setIsOpen(true)}
    className="fixed top-4 left-4 z-50 p-3 bg-white border border-slate-200 text-slate-600 rounded-full shadow-lg
    hover:rotate-90 transition-all duration-500 hover:text-slate-900"
    >
    <Settings size={24} />
</button>
);
}

return (
<div
    className="fixed top-4 left-4 z-50 w-72 bg-white/95 backdrop-blur-xl border border-slate-200 rounded-2xl shadow-2xl p-5 animate-fade-in-right overflow-y-auto max-h-[90vh]">
    <div className="flex justify-between items-center mb-5">
        <h2 className="text-sm font-bold text-slate-800 flex items-center gap-2">
            <Settings size={16} /> Widget Settings
        </h2>
        <button onClick={()=> setIsOpen(false)} className="text-slate-400 hover:text-slate-600">
            <X size={18} />
        </button>
    </div>

    <div className="space-y-6">
        {/* Language Selector */}
        <div>
            <span
                className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block flex items-center gap-2">
                <Globe size={10} /> Language
            </span>
            <div className="flex gap-2">
                {Object.keys(TEXT_VARIATIONS).map(lang => (
                <button key={lang} onClick={()=> setConfig({ ...config, lang, variantId:
                    TEXT_VARIATIONS[lang].variants[0].id })}
                    className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${config.lang === lang ?
                    'bg-slate-900 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                    >
                    {lang.toUpperCase()}
                </button>
                ))}
            </div>
        </div>

        <div className="h-px bg-slate-100" />

        {/* Positioning */}
        <div>
            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Position</span>
            <div className="flex gap-2 mb-3">
                <button onClick={()=> setConfig({ ...config, position: 'left' })}
                    className={`flex-1 p-2 rounded-md border flex justify-center ${config.position === 'left' ?
                    'bg-slate-100 border-slate-300 text-slate-900' : 'border-slate-100 text-slate-400'}`}
                    >
                    <AlignLeft size={16} />
                </button>
                <button onClick={()=> setConfig({ ...config, position: 'center' })}
                    className={`flex-1 p-2 rounded-md border flex justify-center ${config.position === 'center' ?
                    'bg-slate-100 border-slate-300 text-slate-900' : 'border-slate-100 text-slate-400'}`}
                    >
                    <AlignCenter size={16} />
                </button>
                <button onClick={()=> setConfig({ ...config, position: 'right' })}
                    className={`flex-1 p-2 rounded-md border flex justify-center ${config.position === 'right' ?
                    'bg-slate-100 border-slate-300 text-slate-900' : 'border-slate-100 text-slate-400'}`}
                    >
                    <AlignRight size={16} />
                </button>
            </div>

            {/* Offsets */}
            <div className="grid grid-cols-2 gap-3">
                <div>
                    <label className="text-[10px] text-slate-400 mb-1 flex items-center gap-1">
                        <MoveHorizontal size={10} /> Offset X
                    </label>
                    <input type="number" value={config.offsetX} onChange={(e)=> setConfig({ ...config, offsetX:
                    Number(e.target.value) })}
                    className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-xs"
                    />
                </div>
                <div>
                    <label className="text-[10px] text-slate-400 mb-1 flex items-center gap-1">
                        <MoveVertical size={10} /> Offset Y
                    </label>
                    <input type="number" value={config.offsetY} onChange={(e)=> setConfig({ ...config, offsetY:
                    Number(e.target.value) })}
                    className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-xs"
                    />
                </div>
            </div>
        </div>

        <div className="h-px bg-slate-100" />

        {/* Theme Mode Toggle */}
        <div>
            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Appearance</span>
            <div className="p-1 bg-slate-100 rounded-lg flex relative">
                <button onClick={()=> setConfig({ ...config, themeMode: 'light' })}
                    className={`flex-1 flex items-center justify-center gap-2 py-1.5 text-xs font-medium rounded-md
                    transition-all z-10 ${config.themeMode === 'light' ? 'bg-white text-slate-900 shadow-sm' :
                    'text-slate-500 hover:text-slate-700'}`}
                    >
                    <Sun size={12} /> Light
                </button>
                <button onClick={()=> setConfig({ ...config, themeMode: 'dark' })}
                    className={`flex-1 flex items-center justify-center gap-2 py-1.5 text-xs font-medium rounded-md
                    transition-all z-10 ${config.themeMode === 'dark' ? 'bg-slate-800 text-white shadow-sm' :
                    'text-slate-500 hover:text-slate-700'}`}
                    >
                    <Moon size={12} /> Dark
                </button>
            </div>
        </div>

        {/* Branding */}
        <div>
            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Branding</span>
            <input type="text" value={config.hotelName} onChange={(e)=> setConfig({ ...config, hotelName: e.target.value
            })}
            className="w-full bg-slate-50 border border-slate-200 rounded-md text-xs p-2 text-slate-900 outline-none
            focus:ring-1 focus:ring-slate-300 mb-2"
            placeholder="Hotel Name"
            />
            <div onClick={()=> fileInputRef.current?.click()}
                className="w-full h-12 border-2 border-dashed border-slate-200 rounded-md flex flex-col items-center
                justify-center cursor-pointer hover:bg-slate-50 transition-all"
                >
                {config.hotelLogo ? (
                <img src={config.hotelLogo} alt="Logo" className="h-6 object-contain" />
                ) : (
                <span className="text-[10px] text-slate-400 flex items-center gap-1">
                    <Upload size={10} /> Upload Logo
                </span>
                )}
                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleLogoUpload} />
            </div>
        </div>

        {/* Color Theme */}
        <div>
            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Accent</span>
            <div className="grid grid-cols-5 gap-2">
                {COLOR_THEMES.map(theme => (
                <button key={theme.id} onClick={()=> setConfig({ ...config, themeId: theme.id })}
                    className={`w-8 h-8 rounded-full bg-gradient-to-br ${theme.primary} shadow-sm transition-transform
                    hover:scale-110 ${config.themeId === theme.id ? 'ring-2 ring-offset-2 ring-slate-900 scale-110' :
                    ''}`}
                    />
                    ))}
            </div>
        </div>
    </div>
</div>
);
};

// --- Основное Приложение ---
export default function HotelVoiceAssistant() {
// CONFIG STATE
const [config, setConfig] = useState({
themeMode: 'dark',
lang: 'ru', // Default language
variantId: 'formal',
themeId: 'gold',
hotelName: 'Grand Hotel',
hotelLogo: null,
position: 'right', // 'left', 'center', 'right'
offsetX: 0,
offsetY: 0
});

const [isAdminOpen, setIsAdminOpen] = useState(false);
const [isOpen, setIsOpen] = useState(false);
const [callState, setCallState] = useState('idle');

// Internal visual state override
const [activePos, setActivePos] = useState('right');

// Sync internal activePos with config
useEffect(() => {
setActivePos(config.position);
if (config.position === 'center') {
setIsOpen(true);
} else {
setIsOpen(false);
}
}, [config.position]);

const activeTheme = COLOR_THEMES.find(t => t.id === config.themeId) || COLOR_THEMES[0];
// Select text based on current language
const activeText = TEXT_VARIATIONS[config.lang].variants.find(v => v.id === config.variantId) ||
TEXT_VARIATIONS[config.lang].variants[0];
const styles = THEME_MODES[config.themeMode];

const handleStart = () => {
setCallState('connecting');
setTimeout(() => setCallState('active'), 2000);
};

const handleEnd = () => setCallState('idle');

// Dismiss logic for Center
const handleDismissCenter = () => {
setActivePos('right');
setIsOpen(false);
setCallState('idle');
};

const toggleWidget = () => {
setIsOpen(!isOpen);
if (isOpen) setCallState('idle');
};

// --- Dynamic Positioning & Layout Logic ---
const getPositionStyles = () => {
const baseBottom = 48 + config.offsetY;
const baseSide = 32 + config.offsetX;

let containerStyle = { bottom: `${baseBottom}px`, transition: 'all 0.6s cubic-bezier(0.16, 1, 0.3, 1)' };
let flexClass = 'flex-row';
let originClass = 'origin-bottom-right';

if (activePos === 'right') {
containerStyle.right = `${baseSide}px`;
containerStyle.left = 'auto';
containerStyle.transform = 'none';
flexClass = 'flex-row';
originClass = 'origin-bottom-right';
} else if (activePos === 'left') {
containerStyle.left = `${baseSide}px`;
containerStyle.right = 'auto';
containerStyle.transform = 'none';
flexClass = 'flex-row-reverse';
originClass = 'origin-bottom-left';
} else if (activePos === 'center') {
containerStyle.left = '50%';
containerStyle.right = 'auto';
containerStyle.transform = `translateX(calc(-50% + ${config.offsetX}px))`;
flexClass = 'flex-col items-center';
originClass = 'origin-bottom';
}

return { containerStyle, flexClass, originClass };
};

const { containerStyle, flexClass, originClass } = getPositionStyles();
const isLauncherHidden = activePos === 'center';

return (
<div className="relative min-h-screen w-full font-sans overflow-hidden" style={{ backgroundColor: '#f8fafc' ,
    backgroundImage: `radial-gradient(#cbd5e1 1.5px, transparent 1.5px)`, backgroundSize: '24px 24px' }}>

    <AdminPanel config={config} setConfig={setConfig} isOpen={isAdminOpen} setIsOpen={setIsAdminOpen} />

    {/* --- WIDGET AREA (Dynamic Position) --- */}
    <div className={`fixed z-40 flex items-end gap-4 ${flexClass}`} style={containerStyle}>

        {/* --- SIDE BUBBLE (COMPACT WIDGET) --- */}
        <div style={{ '--pulse-color' : activeTheme.rgb }} className={` relative flex items-center w-[280px] p-4
            rounded-full transition-all duration-500 ${originClass} ${styles.bg} ${styles.shadow} ${styles.text}
            ${isOpen ? 'opacity-100 scale-100' : 'opacity-0 scale-90 pointer-events-none absolute' } /* ACTIVE CALL
            ANIMATION */ ${callState==='active' ? `${styles.activeBorderBase} ${activeTheme.ring}` : '' }
            ${callState==='active' ? 'animate-[pulse-border_2s_infinite]' : '' } `}>
            {/* Close Button - ТОЛЬКО ДЛЯ ЦЕНТРА
            Позиция изменена: top-1/2 -right-12 (сбоку, а не по диагонали)
            */}
            {activePos === 'center' && (
            <button onClick={handleDismissCenter} className={`absolute top-1/2 -translate-y-1/2 -right-12 p-2
                rounded-full ${styles.bg} ${styles.text} ${styles.border} border shadow-md hover:scale-110
                transition-all z-20`}>
                <X size={16} />
            </button>
            )}

            {/* LOGO (Fixed Left inside Bubble) */}
            <div className={`w-12 h-12 rounded-full ${styles.inputBg} flex items-center justify-center overflow-hidden
                shrink-0 border ${styles.border} mr-3`}>
                {config.hotelLogo ? (
                <img src={config.hotelLogo} alt="Logo" className="w-full h-full object-cover" />
                ) : (
                <div className={`w-full h-full ${styles.inputBg}`} />
                )}
            </div>

            {/* DYNAMIC CONTENT */}
            <div className="flex-1 min-w-0 flex flex-col items-center justify-center">

                {callState === 'idle' && (
                <button onClick={handleStart} className={` w-full h-10 px-4 rounded-full text-white font-semibold
                    text-sm shadow-md flex items-center justify-center gap-2 animate-fade-in bg-gradient-to-r
                    ${activeTheme.primary} hover:scale-105 transition-transform active:scale-95 whitespace-nowrap `}>
                    <Mic size={18} />
                    {activeText.button}
                </button>
                )}

                {callState === 'connecting' && (
                <div className="w-full h-10 flex items-center justify-center animate-fade-in">
                    <span className={`text-sm font-medium ${styles.subtext} animate-pulse truncate`}>
                        {activeText.connecting}
                    </span>
                </div>
                )}

                {callState === 'active' && (
                <button onClick={handleEnd}
                    className="w-full h-10 rounded-full bg-red-500/10 border border-red-500/20 text-red-500 text-sm font-bold uppercase tracking-wide hover:bg-red-500 hover:text-white transition-colors flex items-center justify-center gap-2 animate-fade-in whitespace-nowrap">
                    <PhoneOff size={16} />
                    {activeText.end}
                </button>
                )}

            </div>

            {/* FOOTER */}
            <a href="https://hotelmol.com" target="_blank" rel="noopener noreferrer"
                className="absolute -bottom-7 w-full text-center left-0 text-xs font-medium text-slate-500 opacity-90 hover:opacity-100 hover:text-slate-700 transition-all whitespace-nowrap">
                powered by hotelmol.com
            </a>

        </div>

        {/* --- LAUNCHER BUTTON --- */}
        <div className="relative">
            {/* TOOLTIP (Only shows when closed AND on side AND not center) */}
            {!isOpen && activePos !== 'center' && (
            <div className={` absolute top-0 -translate-y-0 whitespace-nowrap py-2 px-4 rounded-xl shadow-lg border
                border-slate-100 text-sm font-medium animate-fade-in pointer-events-none bg-white text-slate-900
                ${activePos==='right' ? 'right-full mr-4 origin-right' : 'left-full ml-4 origin-left' } `}>
                {activeText.tooltip}
                {/* Arrow */}
                <div className={`absolute top-3 -translate-y-1/2 border-8 border-transparent ${activePos==='right'
                    ? 'right-[-8px] border-l-white' : 'left-[-8px] border-r-white' } opacity-100`} />
            </div>
            )}

            <button onClick={toggleWidget} className={` relative w-16 h-16 rounded-full shrink-0 flex items-center
                justify-center shadow-2xl z-50 transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) ${isOpen ?
                `${isLauncherHidden ? 'hidden' : '' } ${styles.bg} ${styles.text} rotate-90 border ${styles.border}` :
                `bg-gradient-to-br ${activeTheme.primary} text-white rotate-0` } `}>
                {isOpen ?
                <X size={28} /> : (
                <div className="relative">
                    <div className="absolute inset-0 animate-ping opacity-20 bg-white rounded-full"></div>
                    <div className="relative w-8 h-8 flex items-center justify-center gap-[3px]">
                        <div className="w-1 h-3 bg-white/80 rounded-full animate-[wave_1.2s_ease-in-out_infinite]" />
                        <div
                            className="w-1 h-5 bg-white/80 rounded-full animate-[wave_1.2s_ease-in-out_0.2s_infinite]" />
                        <div
                            className="w-1 h-3 bg-white/80 rounded-full animate-[wave_1.2s_ease-in-out_0.4s_infinite]" />
                    </div>
                </div>
                )}
            </button>
        </div>

    </div>

    <style>
        {
            ` @keyframes wave {

                0%,
                100% {
                    height: 40%;
                    opacity: 0.5;
                }

                50% {
                    height: 100%;
                    opacity: 1;
                }
            }

            @keyframes pulse-border {
                0% {
                    box-shadow: 0 0 0 0 rgba(var(--pulse-color), 0.7);
                }

                70% {
                    box-shadow: 0 0 0 15px rgba(var(--pulse-color), 0);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(var(--pulse-color), 0);
                }
            }

            .animate-fade-in-right {
                animation: fadeInRight 0.4s ease-out forwards;
            }

            @keyframes fadeInRight {
                from {
                    opacity: 0;
                    transform: translateX(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .animate-fade-in {
                animation: fadeIn 0.3s ease-out forwards;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }

            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            `
        }
    </style>
</div>
);
}