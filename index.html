<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Добавлен maximum-scale=1 для предотвращения зума при фокусе -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Concierge Widget Demo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (Global) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Упрощенные анимации */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Анимация волн для полосок внутри кнопки */
        @keyframes wave {
            0%, 100% { height: 8px; opacity: 0.6; }
            50% { height: 20px; opacity: 1; }
        }

        /* Анимация пульсирующих колец вокруг кнопки */
        @keyframes ripple-ring {
            0% { transform: scale(0.8); opacity: 0.6; border-width: 4px; }
            100% { transform: scale(1.6); opacity: 0; border-width: 0px; }
        }
        
        /* Скрытие скроллбара */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Плавные переходы для размеров и позиций окна виджета */
        .widget-transition {
            transition-property: opacity, transform, width, height, bottom, left, right;
            transition-duration: 400ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-slate-50" style="background-image: url('https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80'); background-size: cover; background-position: center; background-attachment: fixed;">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- МАППИНГ ИКОНОК ---
        const IconWrapper = ({ name, size = 24, className = "", ...props }) => {
            const icons = {
                X: <path d="M18 6 6 18M6 6 18 18" />,
                Mic: <><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/><line x1="8" x2="16" y1="22" y2="22"/></>,
                MicOff: <><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/></>,
                PhoneOff: <><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"/><line x1="23" x2="1" y1="1" y2="23"/></>,
                Settings: <><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></>,
                Globe: <><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></>,
                MessageSquare: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
                Palette: <><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></>,
                Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>,
                Moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>,
                Sun: <><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>,
                ThumbsUp: <><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></>,
                ThumbsDown: <><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H19a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"/></>,
                AlignLeft: <><line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/></>,
                AlignCenter: <><line x1="21" x2="3" y1="6" y2="6"/><line x1="17" x2="7" y1="12" y2="12"/><line x1="19" x2="5" y1="18" y2="18"/></>,
                AlignRight: <><line x1="21" x2="3" y1="6" y2="6"/><line x1="21" x2="9" y1="12" y2="12"/><line x1="21" x2="7" y1="18" y2="18"/></>,
                MoveHorizontal: <><polyline points="18 8 22 12 18 16"/><polyline points="6 8 2 12 6 16"/><line x1="2" x2="22" y1="12" y2="12"/></>,
                MoveVertical: <><polyline points="8 18 12 22 16 18"/><polyline points="8 6 12 2 16 6"/><line x1="12" x2="12" y1="2" y2="22"/></>,
                ArrowRight: <><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></>,
                Telegram: (
                    <>
                        <defs>
                            <linearGradient id="Oval_1_" gradientUnits="userSpaceOnUse" x1="-838.041" y1="660.581" x2="-838.041" y2="660.3427" gradientTransform="matrix(1000 0 0 -1000 838161 660581)">
                                <stop offset="0" stopColor="#2AABEE"/>
                                <stop offset="1" stopColor="#229ED9"/>
                            </linearGradient>
                        </defs>
                        <circle fillRule="evenodd" clipRule="evenodd" fill="url(#Oval_1_)" cx="120.1" cy="120.1" r="120.1"/>
                        <path fillRule="evenodd" clipRule="evenodd" fill="#FFFFFF" d="M54.3,118.8c35-15.2,58.3-25.3,70-30.2 c33.3-13.9,40.3-16.3,44.8-16.4c1,0,3.2,0.2,4.7,1.4c1.2,1,1.5,2.3,1.7,3.3s0.4,3.1,0.2,4.7c-1.8,19-9.6,65.1-13.6,86.3 c-1.7,9-5,12-8.2,12.3c-7,0.6-12.3-4.6-19-9c-10.6-6.9-16.5-11.2-26.8-18c-11.9-7.8-4.2-12.1,2.6-19.1c1.8-1.8,32.5-29.8,33.1-32.3 c0.1-0.3,0.1-1.5-0.6-2.1c-0.7-0.6-1.7-0.4-2.5-0.2c-1.1,0.2-17.9,11.4-50.6,33.5c-4.8,3.3-9.1,4.9-13,4.8 c-4.3-0.1-12.5-2.4-18.7-4.4c-7.5-2.4-13.5-3.7-13-7.9C45.7,123.3,48.7,121.1,54.3,118.8z"/>
                    </>
                ),
                Volume2: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /></>,
                VolumeX: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><line x1="23" y1="9" x2="17" y2="15" /><line x1="17" y1="9" x2="23" y2="15" /></>,
            };

            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                    {...props}
                >
                    {icons[name]}
                </svg>
            );
        };

        const THEME_MODES = {
            dark: {
                id: 'dark',
                bg: 'bg-slate-900/75 backdrop-blur-2xl',
                text: 'text-white',
                subtext: 'text-slate-400',
                border: 'border-white/10',
                inputBg: 'bg-white/5',
                buttonBg: 'bg-white/10 hover:bg-white/20',
                tooltipBg: 'bg-white text-slate-900', 
                shadow: 'shadow-2xl',
                activeBorderBase: 'ring-2 ring-offset-2 ring-offset-slate-900', 
                agentBubble: 'bg-slate-800 text-slate-200 border-white/10',
                userBubble: 'bg-indigo-600 text-white',
            },
            light: {
                id: 'light',
                bg: 'bg-white/60 backdrop-blur-3xl',
                text: 'text-slate-900',
                subtext: 'text-slate-500',
                border: 'border-white/40',
                // Обновлены стили светлой темы: более заметные тени и кольца акцента
                inputBg: 'bg-white/80 shadow-[0_2px_8px_rgba(0,0,0,0.08)] ring-1 ring-black/5',
                buttonBg: 'bg-white/80 hover:bg-white/90 shadow-[0_2px_8px_rgba(0,0,0,0.08)] ring-1 ring-black/5',
                tooltipBg: 'bg-white/80 backdrop-blur-md text-slate-900', 
                shadow: 'shadow-2xl shadow-slate-200/50',
                activeBorderBase: 'ring-2 ring-offset-2 ring-offset-white',
                agentBubble: 'bg-white/90 text-slate-800 border-white/50 shadow-[0_2px_4px_rgba(0,0,0,0.05)] ring-1 ring-black/5',
                userBubble: 'bg-slate-800 text-white shadow-[0_4px_12px_rgba(0,0,0,0.1)]',
            }
        };

        const TEXT_VARIATIONS = {
            ru: {
                label: "Русский",
                variants: [
                    { 
                        id: 'formal', 
                        name: 'Официальный', 
                        greeting: '', 
                        button: 'Начать разговор', 
                        connecting: 'Подключение...', 
                        listening: '', 
                        end: 'Закончить', 
                        title: 'Консьерж',
                        tooltip: 'Привет! Я Феликс :) Чем могу помочь?',
                        ratingTitle: 'Было ли это полезно?',
                        inputPlaceholder: 'Говорите или пишите...',
                        agentWelcome: 'Здравствуйте! Я Феликс. Чем могу помочь?',
                        userMock: 'Хочу заказать ужин в номер.',
                    },
                ]
            },
            en: {
                label: "English",
                variants: [
                    { 
                        id: 'formal', 
                        name: 'Formal', 
                        greeting: '', 
                        button: 'Start Conversation', 
                        connecting: 'Connecting...', 
                        listening: '', 
                        end: 'End Call', 
                        title: 'Concierge',
                        tooltip: 'Hi! I am Felix :) How can I help you?',
                        ratingTitle: 'Was this helpful?',
                        inputPlaceholder: 'Speak or type...',
                        agentWelcome: 'Hello! I am Felix. How can I help you?',
                        userMock: 'I would like to order dinner.',
                    },
                ]
            }
        };

        const COLOR_THEMES = [
            { id: 'gold', name: 'Gold', primary: 'bg-amber-500', glow: 'bg-amber-400', text: 'text-amber-600', accent: 'bg-amber-400', ring: 'ring-amber-400', rgb: '251, 191, 36' },
            { id: 'blue', name: 'Blue', primary: 'bg-blue-600', glow: 'bg-blue-400', text: 'text-blue-600', accent: 'bg-blue-400', ring: 'ring-blue-400', rgb: '96, 165, 250' },
            { id: 'emerald', name: 'Emerald', primary: 'bg-emerald-500', glow: 'bg-emerald-400', text: 'text-emerald-600', accent: 'bg-emerald-400', ring: 'ring-emerald-400', rgb: '52, 211, 153' },
            { id: 'purple', name: 'Purple', primary: 'bg-purple-600', glow: 'bg-fuchsia-400', text: 'text-purple-600', accent: 'bg-fuchsia-400', ring: 'ring-fuchsia-400', rgb: '232, 121, 249' },
            { id: 'red', name: 'Red', primary: 'bg-red-600', glow: 'bg-red-500', text: 'text-red-600', accent: 'bg-red-500', ring: 'ring-red-500', rgb: '239, 68, 68' },
            { id: 'orange', name: 'Orange', primary: 'bg-orange-500', glow: 'bg-orange-400', text: 'text-orange-600', accent: 'bg-orange-400', ring: 'ring-orange-400', rgb: '251, 146, 60' },
            { id: 'cyan', name: 'Cyan', primary: 'bg-cyan-500', glow: 'bg-cyan-400', text: 'text-cyan-600', accent: 'bg-cyan-400', ring: 'ring-cyan-400', rgb: '34, 211, 238' },
            { id: 'pink', name: 'Pink', primary: 'bg-pink-500', glow: 'bg-pink-400', text: 'text-pink-600', accent: 'bg-pink-400', ring: 'ring-pink-400', rgb: '244, 114, 182' },
            { id: 'indigo', name: 'Indigo', primary: 'bg-indigo-600', glow: 'bg-indigo-400', text: 'text-indigo-600', accent: 'bg-indigo-400', ring: 'ring-indigo-400', rgb: '129, 140, 248' },
            { id: 'slate', name: 'Slate', primary: 'bg-slate-600', glow: 'bg-slate-400', text: 'text-slate-600', accent: 'bg-slate-400', ring: 'ring-slate-400', rgb: '148, 163, 184' },
            { id: 'lime', name: 'Lime', primary: 'bg-lime-500', glow: 'bg-lime-400', text: 'text-lime-600', accent: 'bg-lime-400', ring: 'ring-lime-400', rgb: '163, 230, 53' },
            { id: 'rose', name: 'Rose', primary: 'bg-rose-500', glow: 'bg-rose-400', text: 'text-rose-600', accent: 'bg-rose-400', ring: 'ring-rose-400', rgb: '251, 113, 133' },
            { id: 'sky', name: 'Sky', primary: 'bg-sky-500', glow: 'bg-sky-400', text: 'text-sky-600', accent: 'bg-sky-400', ring: 'ring-sky-400', rgb: '56, 189, 248' },
            { id: 'violet', name: 'Violet', primary: 'bg-violet-600', glow: 'bg-violet-400', text: 'text-violet-600', accent: 'bg-violet-400', ring: 'ring-violet-400', rgb: '167, 139, 250' },
            { id: 'teal', name: 'Teal', primary: 'bg-teal-500', glow: 'bg-teal-400', text: 'text-teal-600', accent: 'bg-teal-400', ring: 'ring-teal-400', rgb: '45, 212, 191' },
        ];

        // --- RATING VIEW COMPONENT ---
        const RatingView = ({ activeText, styles, themeColor, onSubmit }) => {
            return (
                <div className="flex flex-col items-center justify-center w-full h-full animate-fade-in">
                    <div className="flex gap-6">
                        <button
                            onClick={() => onSubmit('like')}
                            className={`flex flex-col items-center gap-1 group transition-transform active:scale-90`}
                        >
                            <div className={`p-3 rounded-full ${styles.inputBg} group-hover:bg-emerald-100 group-hover:text-emerald-600 transition-colors ${styles.subtext}`}>
                                <IconWrapper name="ThumbsUp" size={24} />
                            </div>
                        </button>

                        <button
                            onClick={() => onSubmit('dislike')}
                            className={`flex flex-col items-center gap-1 group transition-transform active:scale-90`}
                        >
                            <div className={`p-3 rounded-full ${styles.inputBg} group-hover:bg-red-100 group-hover:text-red-600 transition-colors ${styles.subtext}`}>
                                <IconWrapper name="ThumbsDown" size={24} />
                            </div>
                        </button>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ config, setConfig, isOpen, setIsOpen }) => {
            const fileInputRef = useRef(null);

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setConfig({ ...config, hotelLogo: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            if (!isOpen) {
                return (
                    <button 
                        onClick={() => setIsOpen(true)}
                        className="fixed top-4 left-4 z-50 p-3 bg-white border border-slate-200 text-slate-600 rounded-full shadow-lg hover:scale-110 transition-all duration-300 hover:text-slate-900"
                    >
                        <IconWrapper name="Settings" size={24} />
                    </button>
                );
            }

            return (
                <div className="fixed top-4 left-4 z-50 w-72 bg-white/95 backdrop-blur-xl border border-slate-200 rounded-2xl shadow-2xl p-5 animate-fade-in-right overflow-y-auto max-h-[90vh]">
                    <div className="flex justify-between items-center mb-5">
                        <h2 className="text-sm font-bold text-slate-800 flex items-center gap-2">
                            <IconWrapper name="Settings" size={16} /> Настройки виджета
                        </h2>
                        <button onClick={() => setIsOpen(false)} className="text-slate-400 hover:text-slate-600">
                            <IconWrapper name="X" size={18} />
                        </button>
                    </div>

                    <div className="space-y-6">
                        {/* Выбор языка */}
                        <div>
                            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block flex items-center gap-2">
                                <IconWrapper name="Globe" size={10} /> Язык
                            </span>
                            <div className="flex gap-2">
                                {Object.keys(TEXT_VARIATIONS).map(lang => (
                                    <button
                                        key={lang}
                                        onClick={() => setConfig({ ...config, lang, variantId: TEXT_VARIATIONS[lang].variants[0].id })}
                                        className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${config.lang === lang ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        {lang.toUpperCase()}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="h-px bg-slate-100" />

                        {/* Позиционирование */}
                        <div>
                            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Позиция</span>
                            <div className="flex gap-2 mb-3">
                                <button 
                                    onClick={() => setConfig({ ...config, position: 'left' })}
                                    className={`flex-1 p-2 rounded-md border flex justify-center ${config.position === 'left' ? 'bg-slate-100 border-slate-300 text-slate-900' : 'border-slate-100 text-slate-400'}`}
                                >
                                    <IconWrapper name="AlignLeft" size={16} />
                                </button>
                                <button 
                                    onClick={() => setConfig({ ...config, position: 'center' })}
                                    className={`flex-1 p-2 rounded-md border flex justify-center ${config.position === 'center' ? 'bg-slate-100 border-slate-300 text-slate-900' : 'border-slate-100 text-slate-400'}`}
                                >
                                    <IconWrapper name="AlignCenter" size={16} />
                                </button>
                                <button 
                                    onClick={() => setConfig({ ...config, position: 'right' })}
                                    className={`flex-1 p-2 rounded-md border flex justify-center ${config.position === 'right' ? 'bg-slate-100 border-slate-300 text-slate-900' : 'border-slate-100 text-slate-400'}`}
                                >
                                    <IconWrapper name="AlignRight" size={16} />
                                </button>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[10px] text-slate-400 mb-1 flex items-center gap-1">
                                        <IconWrapper name="MoveHorizontal" size={10} /> Смещение X
                                    </label>
                                    <input 
                                        type="number" 
                                        value={config.offsetX}
                                        onChange={(e) => setConfig({ ...config, offsetX: Number(e.target.value) })}
                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-xs"
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] text-slate-400 mb-1 flex items-center gap-1">
                                        <IconWrapper name="MoveVertical" size={10} /> Смещение Y
                                    </label>
                                    <input 
                                        type="number" 
                                        value={config.offsetY}
                                        onChange={(e) => setConfig({ ...config, offsetY: Number(e.target.value) })}
                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-xs"
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="h-px bg-slate-100" />

                        {/* Тема */}
                        <div>
                            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Внешний вид</span>
                            <div className="p-1 bg-slate-100 rounded-lg flex relative">
                                <button
                                    onClick={() => setConfig({ ...config, themeMode: 'light' })}
                                    className={`flex-1 flex items-center justify-center gap-2 py-1.5 text-xs font-medium rounded-md transition-all z-10 ${config.themeMode === 'light' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <IconWrapper name="Sun" size={12} /> Светлая
                                </button>
                                <button
                                    onClick={() => setConfig({ ...config, themeMode: 'dark' })}
                                    className={`flex-1 flex items-center justify-center gap-2 py-1.5 text-xs font-medium rounded-md transition-all z-10 ${config.themeMode === 'dark' ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <IconWrapper name="Moon" size={12} /> Темная
                                </button>
                            </div>
                        </div>

                        {/* Брендинг - ПОЛЕ ВВОДА УБРАНО, ТОЛЬКО ЗАГРУЗКА ЛОГО */}
                        <div>
                            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Брендинг</span>
                            <div 
                                onClick={() => fileInputRef.current?.click()}
                                className="w-full h-12 border-2 border-dashed border-slate-200 rounded-md flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition-all"
                            >
                                {config.hotelLogo ? (
                                    <img src={config.hotelLogo} alt="Логотип" className="h-6 object-contain" />
                                ) : (
                                    <span className="text-[10px] text-slate-400 flex items-center gap-1"><IconWrapper name="Upload" size={10}/> Загрузить лого</span>
                                )}
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleLogoUpload} />
                            </div>
                        </div>
                        
                        {/* Цвета */}
                        <div>
                            <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Акцент</span>
                            <div className="grid grid-cols-5 gap-2">
                                {COLOR_THEMES.map(theme => (
                                    <button
                                        key={theme.id}
                                        onClick={() => setConfig({ ...config, themeId: theme.id })}
                                        className={`w-8 h-8 rounded-full ${theme.primary} shadow-sm transition-transform hover:scale-110 ${config.themeId === theme.id ? 'ring-2 ring-offset-2 ring-slate-900 scale-110' : ''}`}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const HotelVoiceAssistant = () => {
            const [config, setConfig] = useState({
                themeMode: 'dark',
                lang: 'ru',
                variantId: 'formal',
                themeId: 'gold',
                hotelName: 'Grand Hotel',
                hotelLogo: null,
                position: 'right',
                offsetX: 0,
                offsetY: 0,
                buttonScale: 1.0 // Reset to 1.0 logic, handled by CSS
            });
            
            const [isAdminOpen, setIsAdminOpen] = useState(false);
            const [isOpen, setIsOpen] = useState(false);
            const [callState, setCallState] = useState('idle');
            const [activePos, setActivePos] = useState('right'); 
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isMuted, setIsMuted] = useState(false);
            const [tooltipDismissed, setTooltipDismissed] = useState(false);

            useEffect(() => {
                setActivePos(config.position);
                if (config.position === 'center') {
                    setIsOpen(true);
                } else {
                    setIsOpen(false);
                }
            }, [config.position]);

            const activeTheme = COLOR_THEMES.find(t => t.id === config.themeId) || COLOR_THEMES[0];
            const activeText = TEXT_VARIATIONS[config.lang].variants.find(v => v.id === config.variantId) || TEXT_VARIATIONS[config.lang].variants[0];
            const styles = THEME_MODES[config.themeMode];

            const handleStart = () => {
                setCallState('connecting');
                setMessages([]);
                setTooltipDismissed(true);
                setTimeout(() => {
                    setCallState('active');
                    setTimeout(() => {
                        setMessages([
                            { id: 1, sender: 'agent', text: activeText.agentWelcome },
                            { id: 2, sender: 'user', text: activeText.userMock },
                        ]);
                    }, 500);
                }, 2000);
            };

            const handleEnd = () => {
                setCallState('rating');
            };

            const handleSendText = () => {
                if (inputValue.trim()) {
                    setMessages(prev => [...prev, { id: Date.now(), sender: 'user', text: inputValue }]);
                    setInputValue('');
                }
            };

            const handleRatingSubmit = () => {
                setCallState('idle');
                setMessages([]);
            };

            const handleDismissCenter = () => {
                setConfig(prev => ({ ...prev, position: 'right' }));
            };

            const handleCloseChatOnly = () => {
                setCallState('idle');
            };

            const toggleWidget = () => {
                setTooltipDismissed(true);
                if (activePos !== 'center') {
                    if (!isOpen) {
                        setIsOpen(true);
                        setCallState('active'); 
                        setMessages([]);
                        setTimeout(() => {
                             setMessages([
                                { id: 1, sender: 'agent', text: activeText.agentWelcome },
                             ]);
                        }, 500);
                    } else {
                        setIsOpen(false);
                        setCallState('idle');
                    }
                } else {
                    setIsOpen(true);
                    setCallState('idle');
                }
            };

            const getPositionStyles = () => {
                const baseBottom = 48 + config.offsetY; 
                const baseSide = 32 + config.offsetX;

                let containerStyle = { bottom: `${baseBottom}px` };
                
                if (activePos === 'center') {
                    containerStyle.bottom = `${baseBottom - 45}px`; 
                }

                let flexClass = 'flex-row'; 
                let originClass = 'origin-bottom-right';

                if (activePos === 'right') {
                    containerStyle.right = `${baseSide}px`;
                    containerStyle.left = 'auto';
                    containerStyle.transform = 'none';
                    flexClass = 'flex-row'; 
                    originClass = 'origin-bottom-right';
                } else if (activePos === 'left') {
                    containerStyle.left = `${baseSide}px`;
                    containerStyle.right = 'auto';
                    containerStyle.transform = 'none';
                    flexClass = 'flex-row-reverse'; 
                    originClass = 'origin-bottom-left';
                } else if (activePos === 'center') {
                    containerStyle.left = '50%';
                    containerStyle.right = 'auto';
                    containerStyle.transform = `translateX(calc(-50% + ${config.offsetX}px))`;
                    flexClass = 'flex-col items-center'; 
                    originClass = 'origin-bottom';
                }

                return { containerStyle, flexClass, originClass };
            };

            const { containerStyle, flexClass, originClass } = getPositionStyles();
            const isLauncherHidden = activePos === 'center' || (activePos !== 'center' && isOpen);

            // КЛАССЫ ПЕРЕОПРЕДЕЛЕНИЯ ДЛЯ МОБИЛЬНОЙ ВЕРСИИ (активный чат сбоку)
            // ИСПРАВЛЕНИЕ: Жестко задана ширина calc(100vw - 30px) и левый отступ 15px.
            // Right-auto гарантирует, что ширина будет считаться от левого края, создавая симметричный отступ справа.
            const mobileActiveSideOverrides = (callState === 'active' && activePos !== 'center')
                ? "max-md:!left-[15px] max-md:!w-[calc(100vw-30px)] max-md:!bottom-[15px] max-md:!right-auto max-md:!transform-none max-md:!m-0"
                : "";

            return (
                <div 
                    className="relative min-h-screen w-full font-sans overflow-hidden"
                    style={{
                        backgroundColor: '#f8fafc',
                        backgroundImage: `radial-gradient(#cbd5e1 1.5px, transparent 1.5px)`,
                        backgroundSize: '24px 24px'
                    }}
                >
                    <AdminPanel config={config} setConfig={setConfig} isOpen={isAdminOpen} setIsOpen={setIsAdminOpen} />
                    
                    <div 
                        className={`fixed z-40 flex items-end gap-4 widget-transition ${flexClass} ${mobileActiveSideOverrides}`}
                        style={containerStyle}
                    >
                        {/* ОКНО ВИДЖЕТА */}
                        <div 
                            className={`
                                relative flex 
                                ${callState === 'active' 
                                    ? `flex-col items-center justify-center ${activePos === 'center' ? 'w-[90vw] md:w-[590px] h-[355px]' : 'w-full max-md:h-[calc(50vh-15px)] md:w-[320px] md:h-[450px]'}` 
                                    : `flex-row items-center ${activePos === 'center' ? 'w-[calc(100vw-10px)] mx-[5px] md:w-[380px] md:mx-auto rounded-full p-2' : 'w-[280px] rounded-2xl p-2'}`
                                }
                                widget-transition ${originClass}
                                ${styles.bg} ${styles.shadow} ${styles.text}
                                ${styles.border} border
                                ${isOpen ? 'opacity-100 scale-100 visible' : 'opacity-0 scale-95 invisible absolute'}
                                ${callState === 'active' ? 'rounded-3xl' : 'rounded-full'}
                            `}
                        >
                            {/* АКТИВНЫЙ РЕЖИМ РАЗГОВОРА */}
                            {callState === 'active' && (
                                <div className="flex flex-col h-full w-full relative overflow-hidden rounded-3xl">
                                    {/* Кнопка закрытия (в чате) */}
                                    {activePos === 'center' ? (
                                        <button 
                                            onClick={handleCloseChatOnly} // ВОТ ТУТ ЛОГИКА ДЛЯ ЦЕНТРА: ЗАКРЫТЬ ТОЛЬКО ЧАТ, ОСТАТЬСЯ В ЦЕНТРЕ
                                            className={`absolute top-4 right-4 z-20 p-2 rounded-full bg-white/20 text-slate-600 shadow-sm border border-white/40 hover:bg-white/40 transition-colors`}
                                        >
                                            <IconWrapper name="X" size={16} />
                                        </button>
                                    ) : (
                                        // Боковой крестик закрытия внутри чата
                                        <button 
                                            onClick={() => {setIsOpen(false); setCallState('idle');}}
                                            className={`absolute top-4 right-4 z-20 p-2 rounded-full bg-white/20 text-slate-600 shadow-sm border border-white/40 hover:bg-white/40 transition-colors`}
                                        >
                                            <IconWrapper name="X" size={16} />
                                        </button>
                                    )}

                                    {/* ЧАТ */}
                                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pt-6 pb-2 scrollbar-hide">
                                        {messages.map((msg) => (
                                            <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`
                                                    max-w-[80%] px-4 py-2 rounded-2xl text-base leading-relaxed shadow-sm
                                                    ${msg.sender === 'user' 
                                                        ? `${activeTheme.primary} text-white rounded-tr-none shadow-md`
                                                        : styles.agentBubble + ' border rounded-tl-none ' + styles.border}
                                                `}>
                                                    {msg.text}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* ПАНЕЛЬ УПРАВЛЕНИЯ */}
                                    <div className={`p-3 border-t ${styles.border} flex items-center gap-2 bg-transparent`}>
                                        <div className={`flex-1 relative rounded-full h-10 flex items-center border transition-all ${styles.inputBg} ${styles.border} focus-within:ring-1 focus-within:ring-slate-300`}>
                                            <input 
                                                type="text" 
                                                value={inputValue}
                                                onChange={(e) => setInputValue(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && handleSendText()}
                                                placeholder={activeText.inputPlaceholder} 
                                                className={`bg-transparent w-full h-full pl-4 pr-10 text-base outline-none placeholder-opacity-50 ${styles.text}`}
                                            />
                                            <div className={`absolute right-1 top-1/2 -translate-y-1/2 transition-all duration-200 ${inputValue.trim().length > 0 ? 'opacity-100 scale-100' : 'opacity-0 scale-90 pointer-events-none'}`}>
                                                <button 
                                                    onClick={handleSendText}
                                                    className={`w-8 h-8 flex items-center justify-center rounded-full ${activeTheme.primary} text-white shadow-md hover:scale-105 active:scale-95 transition-all`}
                                                >
                                                    <IconWrapper name="ArrowRight" size={18} />
                                                </button>
                                            </div>
                                        </div>

                                        <button 
                                            onClick={() => setIsMuted(!isMuted)}
                                            className={`p-2 rounded-full transition-colors ${isMuted ? 'bg-red-100 text-red-500' : styles.buttonBg + ' ' + styles.subtext}`}
                                        >
                                            <IconWrapper name={isMuted ? 'VolumeX' : 'Volume2'} size={18} />
                                        </button>

                                        <button 
                                            onClick={handleEnd}
                                            className="p-2 rounded-full bg-red-500 text-white hover:bg-red-600 shadow-md transition-transform hover:scale-105 active:scale-95"
                                        >
                                            <IconWrapper name="PhoneOff" size={18} />
                                        </button>
                                    </div>
                                    
                                    {/* ПОДВАЛ (Активный) - Поднят на 2px */}
                                    <div className="w-full text-center pb-[10px] text-xs font-medium text-slate-400 opacity-60 relative bottom-[2px]">
                                        powered by hotelmol.com
                                    </div>
                                </div>
                            )}

                            {/* РЕЖИМ ОЖИДАНИЯ (КАПСУЛА) */}
                            {callState !== 'active' && (
                                <>
                                    {/* Внешний крестик (всегда виден в центре, перемещает на бок) */}
                                    {activePos === 'center' && (
                                        <button 
                                            onClick={handleDismissCenter} // ВОТ ТУТ ЛОГИКА ДЛЯ ВНЕШНЕГО КРЕСТИКА: ПЕРЕКЛЮЧИТЬ ВПРАВО
                                            className={`absolute top-1/2 -translate-y-1/2 -right-12 p-2 rounded-full ${styles.bg} ${styles.text} ${styles.border} border shadow-md hover:scale-110 transition-all z-20`}
                                        >
                                            <IconWrapper name="X" size={16} />
                                        </button>
                                    )}

                                    <div className="flex items-center w-full gap-2 rounded-full">
                                        {/* ЛОГОТИП */}
                                        <div className={`w-12 h-12 rounded-full ${styles.inputBg} flex items-center justify-center overflow-hidden border ${styles.border} shrink-0`}>
                                            {config.hotelLogo ? (
                                                <img src={config.hotelLogo} alt="Лого" className="w-full h-full object-cover" />
                                            ) : (
                                                <div className={`w-full h-full ${styles.inputBg}`} />
                                            )}
                                        </div>

                                        {/* ТЕЛЕГРАМ (только центр) */}
                                        {activePos === 'center' && (
                                            <>
                                                <div className="flex items-center shrink-0">
                                                    <a 
                                                        href="https://t.me/yourtelegram" 
                                                        target="_blank" 
                                                        className={`w-12 h-12 rounded-full shadow-sm flex items-center justify-center bg-white overflow-hidden hover:scale-110 transition-transform`}
                                                    >
                                                        <IconWrapper name="Telegram" size={48} viewBox="0 0 240.1 240.1" className="w-full h-full" stroke="none" fill="none" />
                                                    </a>
                                                </div>
                                                <div className={`h-8 w-px ${styles.border} border-r mx-1`}></div>
                                            </>
                                        )}

                                        {/* КНОПКА ЗАПУСКА */}
                                        <div className={`flex-1 min-w-0 h-12 flex flex-col justify-center ${activePos === 'center' ? 'py-1 px-1' : ''}`}>
                                            {callState === 'idle' && (
                                                <button
                                                    onClick={handleStart}
                                                    className={`
                                                        w-full h-full rounded-full text-white font-semibold text-sm shadow-sm
                                                        flex items-center justify-center gap-2
                                                        ${activeTheme.primary}
                                                        hover:brightness-110 transition-all active:scale-95 whitespace-nowrap
                                                    `}
                                                >
                                                    <IconWrapper name="Mic" size={18} />
                                                    {activeText.button}
                                                </button>
                                            )}

                                            {callState === 'connecting' && (
                                                <div className={`w-full h-full flex items-center justify-center rounded-full ${styles.inputBg}`}>
                                                    <span className={`text-sm font-medium ${styles.text} animate-pulse truncate`}>
                                                        {activeText.connecting}
                                                    </span>
                                                </div>
                                            )}

                                            {callState === 'rating' && (
                                                <RatingView 
                                                    activeText={activeText}
                                                    styles={styles}
                                                    themeColor={activeTheme}
                                                    onSubmit={handleRatingSubmit}
                                                />
                                            )}
                                        </div>
                                    </div>

                                    {/* ПОДВАЛ (Капсула) */}
                                    {activePos === 'center' && (
                                        <a 
                                            href="https://hotelmol.com" 
                                            target="_blank" 
                                            rel="noopener noreferrer" 
                                            className="absolute -bottom-6 w-full text-center left-0 text-xs font-semibold text-slate-500 opacity-90 hover:opacity-100 hover:text-slate-700 transition-all whitespace-nowrap"
                                        >
                                            powered by hotelmol.com
                                        </a>
                                    )}
                                    {activePos !== 'center' && (
                                         <a 
                                            href="https://hotelmol.com" 
                                            target="_blank" 
                                            rel="noopener noreferrer" 
                                            className="absolute -bottom-7 w-full text-center left-0 text-xs font-medium text-slate-500 opacity-90 hover:opacity-100 hover:text-slate-700 transition-all whitespace-nowrap"
                                        >
                                            powered by hotelmol.com
                                        </a>
                                    )}
                                </>
                            )}
                        </div>

                        {/* КНОПКА-ЛАУНЧЕР */}
                        <div className={`flex flex-col gap-4 items-center transition-transform duration-300 origin-bottom ${isOpen && activePos !== 'center' ? 'scale-75 md:scale-100 max-md:hidden' : ''}`}>
                            {/* ВНЕШНЯЯ КНОПКА ТЕЛЕГРАМ (только если не в центре И если чат не открыт) */}
                            {activePos !== 'center' && !isOpen && (
                                <a 
                                    href="https://t.me/yourtelegram" 
                                    target="_blank" 
                                    className={`relative w-16 h-16 rounded-full shadow-2xl hover:scale-110 transition-transform active:scale-95 flex items-center justify-center bg-white overflow-hidden ${isOpen ? 'scale-75 md:scale-100 mb-[-10px]' : ''}`}
                                >
                                    <IconWrapper name="Telegram" size={64} viewBox="0 0 240.1 240.1" className="w-full h-full" stroke="none" fill="none" />
                                </a>
                            )}

                            <div className="relative flex items-center justify-center">
                                {/* Эффект пульсации */}
                                {!isOpen && activePos !== 'center' && (
                                    <>
                                        <div className={`absolute inset-0 rounded-full border border-white/40 animate-[ripple-ring_2s_infinite] z-0 pointer-events-none`} />
                                        <div className={`absolute inset-0 rounded-full border border-white/40 animate-[ripple-ring_2s_infinite] z-0 pointer-events-none`} style={{ animationDelay: '0.6s' }} />
                                    </>
                                )}

                                {/* ТУЛТИП УДАЛЕН ПОЛНОСТЬЮ */}
                                
                                <button
                                    onClick={toggleWidget}
                                    className={`
                                        relative w-16 h-16 rounded-full shrink-0
                                        flex items-center justify-center 
                                        shadow-2xl z-50
                                        transition-all duration-300 ease-out
                                        ${isOpen && activePos !== 'center' ? 'hidden' : ''} 
                                        ${isOpen 
                                            ? `${isLauncherHidden ? 'hidden' : ''} ${styles.bg} ${styles.text} rotate-90 border ${styles.border} scale-75 md:scale-100` 
                                            : `${activeTheme.primary} text-white rotate-0`
                                        }
                                    `}
                                >
                                    {isOpen ? <IconWrapper name="X" size={28} /> : (
                                        <div className="flex items-center justify-center gap-1 h-6">
                                            <div className="w-1 bg-white rounded-full animate-[wave_1s_ease-in-out_infinite]"></div>
                                            <div className="w-1 bg-white rounded-full animate-[wave_1s_ease-in-out_0.2s_infinite]"></div>
                                            <div className="w-1 bg-white rounded-full animate-[wave_1s_ease-in-out_0.4s_infinite]"></div>
                                        </div>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HotelVoiceAssistant />);
    </script>
</body>
</html>
